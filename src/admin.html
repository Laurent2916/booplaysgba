<!DOCTYPE html>
<html>

<head>
  <title>Admin</title>

  <style>
    * {
      padding: 0;
      margin: 0;
    }

    #dashboard {
      display: none;
    }
  </style>

</head>

<body>

  <div id="login">
    <input type="password" id="password-text">
    <input type="button" id="password-button" value="Login" onclick="sendCreds();">
  </div>

  <div id="dashboard">
    <ul id="stateList"></ul>
    <button id="save">save</button>
  </div>

  <script>
    let websocket = new WebSocket("wss://gba.inpt.fr:6789/");
    let passwordInput = document.querySelector('#password-text');

    let divLogin = document.querySelector("#login");
    let divDashboard = document.querySelector("#dashboard");
    let stateList = document.querySelector("#stateList");
    let saveButton = document.getElementById('save');

    saveButton.onclick = function (event) {
      websocket.send(JSON.stringify({ 'admin': 'save' }));
    }

    function receiveStates(ev) {
      let msg = JSON.parse(ev.data);
      let states = msg.states
      for (let i = 0; i < states.length; i++) {
        let state = states[i];
        let li = document.createElement('li');
        let button = document.createElement('button');
        button.onclick = () => websocket.send(JSON.stringify({ 'admin': "load:" + state }))
        button.appendChild(document.createTextNode(state));
        li.appendChild(button);
        stateList.appendChild(li);
      }
    }

    function authSuccess(ev) {
      let msg = JSON.parse(ev.data);
      if (msg.auth === "success") {
        divLogin.style.display = "none";
        divDashboard.style.display = "unset";
        websocket.removeEventListener('message', authSuccess);
        receiveStates(ev);
      }
    };

    function sendCreds() {
      let message = JSON.stringify({ "auth": passwordInput.value });
      websocket.send(message)
      websocket.addEventListener('message', authSuccess);
    };

    passwordInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") { sendCreds(); }
    });
  </script>
</body>

</html>
